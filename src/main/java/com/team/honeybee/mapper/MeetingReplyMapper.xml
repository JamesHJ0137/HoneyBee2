<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.honeybee.mapper.MeetingReplyMapper">
	
	<!-- 회원 댓글 작성 -->
	<insert id="insertMeetingReply" useGeneratedKeys="true" keyColumn="meetingReplyId" keyProperty="meetingReplyId">
		INSERT INTO MeetingReply (  member_id
							      , meeting_id
							      , content
							      , refNum
							      , step
							      , refOrder
							      , answerNum
							      , parentNum
				 			      )
		        VALUES ( 
		                  #{memberId}
		                , #{meetingId}
		                , #{content}
		                , #{refNum}
					    , 0
					    , 0
					    , #{meetingReplyId}
					    , #{meetingReplyId}
		               )
	</insert>
	
	
	<!-- 회원 댓글 작성 -->
	<insert id="insertMeetingReplyChild">
		INSERT INTO MeetingReply (  member_id
							      , meeting_id
							      , content
							      , refNum
							      , step
							      , refOrder
							      , answerNum
							      , parentNum
				 			      )
		        VALUES ( 
		                  #{memberId}
		                , #{meetingId}
		                , #{content}
		                , #{refNum}
					    , (select max(step)+1 from MeetingReply where #{meetingReplyId})
					    , (select max(refOrder)+1 from MeetingReply where #{meetingReplyId})
					    , #{meetingReplyId}
					    , #{meetingReplyId}
		               )
	</insert>
	
	<!-- 댓글입력시 생성번호를 부모 댓글 번호로 넣기 -->
	<update id="updateMeetingReplyParent">
		UPDATE MeetingReply 
		SET meeting_reply_parent = #{meetingReplyId},
			meeting_reply_gnum = #{meetingReplyId}
		WHERE meeting_reply_id = #{meetingReplyId}
	</update>
	
	<!-- 조상 댓글 목록 출력 -->
	<select id="selectAllMeetingId" resultType="com.team.honeybee.domain.MeetingReplyDto">
		SELECT r.meeting_reply_id meetingReplyId,
			   r.meeting_id meetingId,
			   r.member_id memberId,
			   r.content,
			   r.inserted,
			   m.nickname
		FROM MeetingReply r JOIN Member m ON r.member_id = m.member_id
		WHERE r.meeting_id = #{meetingId}
		  AND r.meeting_reply_id = r.meeting_reply_parent
		ORDER BY meeting_reply_id
	</select>
	
	<!--  자식 댓글 목록 출력 -->
	<select id="selectAllChildrenByParentReplyId" resultType="com.team.honeybee.domain.MeetingReplyDto">
		SELECT r.meeting_reply_id meetingReplyId,
			   r.meeting_id meetingId,
			   r.member_id memberId,
			   r.content,
			   r.inserted,
			   m.nickname
		FROM MeetingReply r JOIN Member m ON r.member_id = m.member_id
		WHERE r.meeting_reply_parent = #{parentId}
		  AND r.meeting_reply_id != r.meeting_reply_parent	
		ORDER BY meeting_reply_id
	
	</select>
	
	
	

</mapper>